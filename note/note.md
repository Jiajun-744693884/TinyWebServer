# note

## 内容细节

### 3.web 服务器如何接受客户端发来的HTTP 请求报文

远端的很多用户会尝试去connect()这个Web Server上正在listen的这个port，而监听到的这些连接会排队等待被accept()。由于用户连接请求是随机到达的异步事件，每当监听socket（listenfd）listen到**新的客户连接并且放入监听队列**，我们都需要告诉我们的Web服务器有连接来了，accept这个连接，并分配一个逻辑单元来处理这个用户请求。而且，我们在处理这个请求的同时，还需要继续监听其他客户的请求并分配其另一逻辑单元来处理（并发，同时处理多个事件，后面会提到使用线程池实现并发）。这里，服务器通过epoll这种I/O复用技术（还有select和poll）来实现对监听socket（listenfd）和连接socket（客户请求）的同时监听。注意I/O复用虽然可以同时监听多个文件描述符，但是它本身是阻塞的，并且当有多个文件描述符同时就绪的时候，如果不采取额外措施，程序则只能按顺序处理其中就绪的每一个文件描述符，所以为提高效率，我们将在这部分通过线程池来实现并发（多线程并发），为每个就绪的文件描述符分配一个逻辑单元（线程）来处理。

## 其他相关细节

### socket linger

socket linger 是一个 控制 套接字关闭 的选项 包括两个成员：

- l_onoff: 0/1; 设置为1 时，开启套接字延迟关闭。设置为0时，关闭。开启了套接字延迟关闭，使用linger 成员配置延迟关闭的行为。
- l_linger: 表示延迟关闭的时间（以秒为单位）。如果 l_onoff 设置为1，并且 l_linger 设置为一个大于0的值，那么在套接字关闭时，系统会等待一段时间，直到发送或接收缓冲区中的数据被发送完毕或等待时间到期，然后再真正关闭套接字。

要作用是确保在关闭套接字之前，尽可能多的数据能够被发送或接收。

|l_onoff|l_linger|close socket 行为| 发送队列| 底层行为|
|----|----|----|----|----|
|0|非0|直接关闭|？（丢弃还是保留）|？|
|1|0|直接关闭|立即放弃|直接使用RST 进行关闭socket，不经过2MSL 时间|
|1|>=1|阻塞知道时间超时或者数据发送完成|超时时间内持续发送，超时后立即放弃|超时同情况2，否则发送成功|

### socket close 和 shutdown

### 
